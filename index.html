<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Book Grid Explorer</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background-color: #1a1a1a;
      color: #fff;
    }
    svg {
      width: 100vw;
      height: 150vh;
      overflow: visible;
    }
    .tooltip {
      position: absolute;
      background: rgba(0,0,0,0.8);
      padding: 10px;
      color: white;
      border-radius: 6px;
      pointer-events: none;
      font-size: 13px;
      max-width: 250px;
      display: none;
    }
    #controls {
      position: fixed;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.7);
      padding: 10px;
      border-radius: 8px;
      z-index: 10;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .filter-section {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
    }
    .filter-pill {
      background-color: rgba(255,255,255,0.2);
      border: 1px solid rgba(255,255,255,0.3);
      color: white;
      padding: 5px 10px;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 12px;
    }
    .filter-pill.active {
      background-color: #4CAF50;
      border-color: #4CAF50;
    }
    .filter-label {
      margin-bottom: 5px;
      font-weight: bold;
    }
  </style>
</head>
<body>

<div id="controls">
  <div>
    <div class="filter-label">Filter by Genre:</div>
    <div id="genreFilter" class="filter-section">
      <div class="filter-pill" data-value="All">All</div>
      <div class="filter-pill" data-value="adventure">Adventure</div>
      <div class="filter-pill" data-value="chick-lit">Chick Lit</div>
      <div class="filter-pill" data-value="crime">Crime</div>
      <div class="filter-pill" data-value="drama">Drama</div>
      <div class="filter-pill" data-value="fantasy">Fantasy</div>
      <div class="filter-pill" data-value="historical">Historical</div>
      <div class="filter-pill" data-value="horror">Horror</div>
      <div class="filter-pill" data-value="humor">Humor</div>
      <div class="filter-pill" data-value="literature">Literature</div>
      <div class="filter-pill" data-value="mystery">Mystery</div>
      <div class="filter-pill" data-value="romance">Romance</div>
      <div class="filter-pill" data-value="science-fiction">Science Fiction</div>
      <div class="filter-pill" data-value="thriller">Thriller</div>
      <div class="filter-pill" data-value="young-adult">Young Adult</div>
    </div>
  </div>
  
  <div>
    <div class="filter-label">Filter by Author Gender:</div>
    <div id="genderFilter" class="filter-section">
      <div class="filter-pill" data-value="All">All</div>
      <div class="filter-pill" data-value="male">Male</div>
      <div class="filter-pill" data-value="female">Female</div>
    </div>
  </div>
</div>

<div class="tooltip" id="tooltip"></div>
<svg id="chart"></svg>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
const svg = d3.select("#chart");
const tooltip = d3.select("#tooltip");
const genreFilter = document.getElementById("genreFilter");
const genderFilter = document.getElementById("genderFilter");

const width = window.innerWidth;
const height = window.innerHeight * 1.5;
const margin = {top: 20, right: 20, bottom: 20, left: 20};

let books = [];
let currentGenreFilter = "All";
let currentGenderFilter = "All";

// click event listners
genreFilter.addEventListener("click", (event) => {
  if (event.target.classList.contains('filter-pill')) {
    genreFilter.querySelectorAll('.filter-pill').forEach(pill => 
      pill.classList.remove('active')
    );
    
    event.target.classList.add('active');
    
    currentGenreFilter = event.target.dataset.value;
    
    filterBooks();
  }
});

// click event listeners
genderFilter.addEventListener("click", (event) => {
  if (event.target.classList.contains('filter-pill')) {
    genderFilter.querySelectorAll('.filter-pill').forEach(pill => 
      pill.classList.remove('active')
    );
    
    event.target.classList.add('active');
    
    currentGenderFilter = event.target.dataset.value;
    
    filterBooks();
  }
});

function highlightCluster(centerBook, bookList, clusterSize = 6) {
  const centerIndex = bookList.findIndex(b => b === centerBook);
  const cluster = [];

  for (let i = -Math.floor(clusterSize / 2); i <= Math.floor(clusterSize / 2); i++) {
    const idx = centerIndex + i;
    if (idx >= 0 && idx < bookList.length && bookList[idx] !== centerBook) {
      cluster.push(bookList[idx]);
    }
  }

  svg.selectAll("image")
    .attr("opacity", d => (d === centerBook || cluster.includes(d)) ? 1 : 0.1)
    .attr("stroke", d => (d === centerBook) ? "gold" : cluster.includes(d) ? "lightblue" : null)
    .attr("stroke-width", d => (d === centerBook || cluster.includes(d)) ? 2 : 0);

  svg.selectAll("image").sort((a, b) => {
    if (a === centerBook) return 1;
    if (cluster.includes(a)) return 1;
    return -1;
  });
}

function draw(filtered) {
  svg.selectAll("*").remove();

  const gridSize = 80;
  const padding = 10;
  const columns = Math.floor(width / (gridSize + padding));

  svg.selectAll("image")
    .data(filtered)
    .join("image")
    .attr("x", (d, i) => {
      const col = i % columns;
      return col * (gridSize + padding) + padding;
    })
    .attr("y", (d, i) => {
      const row = Math.floor(i / columns);
      return row * (gridSize + padding) + padding;
    })
    .attr("width", gridSize)
    .attr("height", gridSize * 1.5)
    .attr("xlink:href", d => `https://covers.openlibrary.org/b/isbn/${d.isbn13}-M.jpg`)
    .on("mouseover", (event, d) => {
      tooltip.style("display", "block")
        .html(`
          <strong>${d.title}</strong><br/>
          Author: ${d.author}<br/>
          Genre: ${d.genre}<br/>
          Labels: ${d.labels.join(", ")}
        `);
    })
    .on("mousemove", event => {
      tooltip
        .style("left", (event.pageX + 10) + "px")
        .style("top", (event.pageY + 10) + "px");
    })
    .on("mouseout", () => tooltip.style("display", "none"))
    .on("click", (event, d) => {
      highlightCluster(d, filtered);
    });
}

function filterBooks() {
  const filtered = books.filter(b => 
    (currentGenreFilter === "All" || b.genre === currentGenreFilter) &&
    (currentGenderFilter === "All" || b.gender === currentGenderFilter)
  );

  draw(filtered);
}

function checkImage(url) {
  return new Promise(resolve => {
    const img = new Image();
    img.onload = () => resolve(true);
    img.onerror = () => resolve(false);
    img.src = url;
  });
}

async function loadData() {
  const data = await d3.json("data/json_output.json");

  const rawBooks = data.filter(d => d.grid_point && d.isbn13).slice(0, 2000);
  const withCovers = await Promise.all(rawBooks.map(async d => {
    const url = `https://covers.openlibrary.org/b/isbn/${d.isbn13}-M.jpg`;
    const hasCover = await checkImage(url);
    return hasCover ? d : null;
  }));

  books = withCovers.filter(Boolean);
  
  genreFilter.querySelector('.filter-pill[data-value="All"]').classList.add('active');
  genderFilter.querySelector('.filter-pill[data-value="All"]').classList.add('active');
  
  draw(books);
}

loadData();
</script>

</body>
</html>